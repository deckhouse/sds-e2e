# GitLab CI конфигурация для тестирования sds-node-configurator модуля

.sds_node_configurator_template: &sds_node_configurator_template
  image: golang:1.22
  variables:
    MODULE_NAME: "sds-node-configurator"
  before_script:
    - mkdir -p ../../sds-e2e-cfg
    - echo "$KUBECONFIG_BARE_METAL" > ../../sds-e2e-cfg/kube-bare-metal.config
    - echo "$KUBECONFIG_HYPERVISOR" > ../../sds-e2e-cfg/kube-hypervisor.config
    - echo "$SSH_PRIVATE_KEY" > ../../sds-e2e-cfg/id_rsa_test
    - chmod 600 ../../sds-e2e-cfg/id_rsa_test
  after_script:
    - kubectl --kubeconfig ../../sds-e2e-cfg/kube-bare-metal.config delete namespace $TEST_NAMESPACE --ignore-not-found=true || true
    - kubectl --kubeconfig ../../sds-e2e-cfg/kube-hypervisor.config delete namespace $TEST_NAMESPACE --ignore-not-found=true || true
  artifacts:
    reports:
      junit: test-results/sds-node-configurator-*.xml
    paths:
      - test-results/
    expire_in: 1 month

# Smoke тесты для sds-node-configurator
sds_node_configurator_smoke:
  <<: *sds_node_configurator_template
  stage: smoke-tests
  script:
    - cd testkit_v2
    - go test -v -timeout 10m ./tests/00_healthcheck_test.go -stand local -verbose
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /^(main|develop)$/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Интеграционные тесты на bare metal
sds_node_configurator_bare_metal:
  <<: *sds_node_configurator_template
  stage: integration-tests
  tags:
    - bare-metal
    - k8s-cluster
    - lvm-support
  variables:
    TEST_ENVIRONMENT: "bare-metal"
    TEST_NAMESPACE: "test-e2e-${CI_PIPELINE_ID}-sds-nc"
  script:
    - cd testkit_v2
    - go test -v -timeout 30m ./tests/01_sds_nc_test.go \
      -stand metal \
      -verbose \
      -debug \
      -kconfig ../../sds-e2e-cfg/kube-bare-metal.config \
      -sshhost $SSH_HOST \
      -sshkey ../../sds-e2e-cfg/id_rsa_test \
      -namespace $TEST_NAMESPACE \
      -run "TestLvg"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /^(main|develop)$/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  timeout: 1h

# Интеграционные тесты на hypervisor
sds_node_configurator_hypervisor:
  <<: *sds_node_configurator_template
  stage: integration-tests
  tags:
    - hypervisor
    - k8s-cluster
    - virtualization
    - nested-vm
  variables:
    TEST_ENVIRONMENT: "hypervisor"
    TEST_NAMESPACE: "test-e2e-${CI_PIPELINE_ID}-sds-nc"
  script:
    - cd testkit_v2
    - go test -v -timeout 60m ./tests/01_sds_nc_test.go \
      -stand metal \
      -verbose \
      -debug \
      -hypervisorkconfig ../../sds-e2e-cfg/kube-hypervisor.config \
      -sshhost $SSH_HOST \
      -sshkey ../../sds-e2e-cfg/id_rsa_test \
      -namespace $TEST_NAMESPACE \
      -run "TestLvg"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /^(main|develop)$/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  timeout: 2h

# LVG создание тесты
sds_node_configurator_lvg_create:
  <<: *sds_node_configurator_template
  stage: integration-tests
  tags:
    - bare-metal
    - k8s-cluster
    - lvm-support
  variables:
    TEST_ENVIRONMENT: "bare-metal"
    TEST_NAMESPACE: "test-e2e-${CI_PIPELINE_ID}-sds-nc-create"
  script:
    - cd testkit_v2
    - go test -v -timeout 45m ./tests/01_sds_nc_test.go \
      -stand metal \
      -verbose \
      -debug \
      -kconfig ../../sds-e2e-cfg/kube-bare-metal.config \
      -sshhost $SSH_HOST \
      -sshkey ../../sds-e2e-cfg/id_rsa_test \
      -namespace $TEST_NAMESPACE \
      -run "TestLvg/create"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /^(main|develop)$/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  timeout: 1h

# LVG изменение размера тесты
sds_node_configurator_lvg_resize:
  <<: *sds_node_configurator_template
  stage: integration-tests
  tags:
    - bare-metal
    - k8s-cluster
    - lvm-support
  variables:
    TEST_ENVIRONMENT: "bare-metal"
    TEST_NAMESPACE: "test-e2e-${CI_PIPELINE_ID}-sds-nc-resize"
  script:
    - cd testkit_v2
    - go test -v -timeout 45m ./tests/01_sds_nc_test.go \
      -stand metal \
      -verbose \
      -debug \
      -kconfig ../../sds-e2e-cfg/kube-bare-metal.config \
      -sshhost $SSH_HOST \
      -sshkey ../../sds-e2e-cfg/id_rsa_test \
      -namespace $TEST_NAMESPACE \
      -run "TestLvg/resize"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /^(main|develop)$/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  timeout: 1h

# LVG удаление тесты
sds_node_configurator_lvg_delete:
  <<: *sds_node_configurator_template
  stage: integration-tests
  tags:
    - bare-metal
    - k8s-cluster
    - lvm-support
  variables:
    TEST_ENVIRONMENT: "bare-metal"
    TEST_NAMESPACE: "test-e2e-${CI_PIPELINE_ID}-sds-nc-delete"
  script:
    - cd testkit_v2
    - go test -v -timeout 45m ./tests/01_sds_nc_test.go \
      -stand metal \
      -verbose \
      -debug \
      -kconfig ../../sds-e2e-cfg/kube-bare-metal.config \
      -sshhost $SSH_HOST \
      -sshkey ../../sds-e2e-cfg/id_rsa_test \
      -namespace $TEST_NAMESPACE \
      -run "TestLvg/delete"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /^(main|develop)$/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  timeout: 1h

# BlockDevice тесты
sds_node_configurator_blockdevice:
  <<: *sds_node_configurator_template
  stage: integration-tests
  tags:
    - bare-metal
    - k8s-cluster
    - lvm-support
  variables:
    TEST_ENVIRONMENT: "bare-metal"
    TEST_NAMESPACE: "test-e2e-${CI_PIPELINE_ID}-sds-nc-bd"
  script:
    - cd testkit_v2
    - go test -v -timeout 30m ./tests/05_sds_node_configurator_test.go \
      -stand metal \
      -verbose \
      -debug \
      -kconfig ../../sds-e2e-cfg/kube-bare-metal.config \
      -sshhost $SSH_HOST \
      -sshkey ../../sds-e2e-cfg/id_rsa_test \
      -namespace $TEST_NAMESPACE \
      -run "TestBlockDevice"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH =~ /^(main|develop)$/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  timeout: 1h

# Ручные тесты для sds-node-configurator
sds_node_configurator_manual:
  <<: *sds_node_configurator_template
  stage: integration-tests
  tags:
    - bare-metal
    - k8s-cluster
    - lvm-support
  variables:
    TEST_ENVIRONMENT: "bare-metal"
    TEST_NAMESPACE: "test-e2e-manual-${CI_PIPELINE_ID}-sds-nc"
  script:
    - cd testkit_v2
    - go test -v -timeout 60m ./tests/01_sds_nc_test.go ./tests/05_sds_node_configurator_test.go \
      -stand metal \
      -verbose \
      -debug \
      -kconfig ../../sds-e2e-cfg/kube-bare-metal.config \
      -sshhost $SSH_HOST \
      -sshkey ../../sds-e2e-cfg/id_rsa_test \
      -namespace $TEST_NAMESPACE
  when: manual
  timeout: 2h
