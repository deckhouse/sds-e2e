# E2E Ñ‚ĞµÑÑ‚Ñ‹: Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ² ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğµ

## ğŸ¯ ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ

E2E Ñ‚ĞµÑÑ‚Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ÑÑ‚ÑÑ **ĞĞ• Ğ½Ğ° GitHub runners**, Ğ° **Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Kubernetes ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ°** ĞºĞ°Ğº Kubernetes Job.

## ğŸ“ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GitHub Actions                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Parse Labels â”‚ â†’ â”‚ Build Module â”‚ â†’ â”‚ Trigger E2E Job  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                    kubectl apply -f job.yaml
                                                    â”‚
                                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    E2E Kubernetes Cluster                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               Namespace: e2e-tests                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚      Job: e2e-test-<module>-<run-id>             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Pod: e2e-test-pod                           â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  1. Clone sds-e2e repo                 â”‚  â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  2. go mod download                    â”‚  â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  3. go test ./tests/...                â”‚  â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚     - Setup DVP/VM cluster            â”‚  â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚     - Run tests                       â”‚  â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚     - Cleanup                         â”‚  â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ logs, status
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GitHub Actions                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Wait for Job â†’ Get Logs â†’ Comment PR â†’ Cleanup Job      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ ĞšĞ°Ğº ÑÑ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚

### 1. GitHub Actions CI (Ğ½Ğ° Ñ€Ğ°Ğ½Ğ½ĞµÑ€Ğµ)

**Ğ”ĞµĞ»Ğ°ĞµÑ‚:**
- ĞŸĞ°Ñ€ÑĞ¸Ñ‚ Ğ»ĞµĞ¹Ğ±Ğ»Ñ‹ PR
- Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ
- Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Kubernetes Job Ğ² e2e ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğµ
- Ğ–Ğ´ĞµÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Job
- ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸
- ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ² PR
- Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Job

**ĞĞ• Ğ´ĞµĞ»Ğ°ĞµÑ‚:**
- ĞĞ• Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ñ‚ĞµÑÑ‚Ñ‹ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾
- ĞĞ• ĞºĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ sds-e2e
- ĞĞ• ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Go Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
- ĞĞ• Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ `go test`

### 2. Kubernetes Job (Ğ² e2e ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğµ)

**Ğ”ĞµĞ»Ğ°ĞµÑ‚:**
- ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ sds-e2e Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
- Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Go Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
- Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ `go test`
- Ğ¢ĞµÑÑ‚Ñ‹ ÑĞ°Ğ¼Ğ¸ Ğ¿Ğ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ÑÑ‚ DVP/VM ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ñ‹
- Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ñ‚ĞµÑÑ‚Ñ‹
- ĞÑ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ

## ğŸ“¦ ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ ÑĞµĞºÑ€ĞµÑ‚Ñ‹

### Ğ’ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ

```bash
# Kubeconfig Ğ´Ğ»Ñ E2E ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ° (Ğ³Ğ´Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒÑÑ Job'Ñ‹)
gh secret set E2E_CLUSTER_KUBECONFIG < e2e-cluster-kubeconfig-base64.txt

# Kubeconfig Ğ´Ğ»Ñ hypervisor (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ñ‚ĞµÑÑ‚Ğ¾Ğ²)
gh secret set KUBECONFIG_HYPERVISOR < hypervisor-kubeconfig-base64.txt

# SSH Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ½Ğ¾Ğ´Ğ°Ğ¼
gh secret set SSH_PRIVATE_KEY < ssh-key.txt
gh secret set SSH_HOST --body "user@hostname"

# Deckhouse Ğ»Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ñ
gh secret set DECKHOUSE_LICENSE < license.txt
```

### ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° kubeconfig Ğ´Ğ»Ñ E2E ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ°

```bash
# E2E ĞºĞ»Ğ°ÑÑ‚ĞµÑ€ - Ğ³Ğ´Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ÑÑ‚ÑÑ Job'Ñ‹
cat ~/.kube/e2e-cluster-config | base64 -w 0 | gh secret set E2E_CLUSTER_KUBECONFIG

# Hypervisor ĞºĞ»Ğ°ÑÑ‚ĞµÑ€ - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ VM
cat ~/.kube/hypervisor-config | base64 -w 0 | gh secret set KUBECONFIG_HYPERVISOR
```

## ğŸš€ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

```bash
# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ»ĞµĞ¹Ğ±Ğ» Ğ² PR
gh pr edit <PR_NUMBER> --add-label "e2e-test"
```

**Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚:**
1. GitHub Actions ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ Job Ğ² e2e ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğµ
2. Job Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Pod Ñ `golang:1.22`
3. Pod ĞºĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ `sds-e2e`
4. Pod Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ `go test`
5. Ğ¢ĞµÑÑ‚Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ DVP/VM ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ñ‹
6. Ğ¢ĞµÑÑ‚Ñ‹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑÑ‚ÑÑ
7. Ğ›Ğ¾Ğ³Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ÑÑ‚ÑÑ Ğ² GitHub Actions
8. Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºÑƒÑÑ‚ÑÑ Ğ² PR

### Ğ¡ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¾Ğ¿Ñ†Ğ¸ÑĞ¼Ğ¸

```bash
# ĞŸĞ¾Ğ»Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ½Ğ° hypervisor
gh pr edit <PR_NUMBER> \
  --add-label "e2e-test" \
  --add-label "e2e:full" \
  --add-label "e2e:hypervisor"
```

## ğŸ” ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ°

### ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ñ… Job'Ğ¾Ğ²

```bash
# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº e2e ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ñƒ
export KUBECONFIG=~/.kube/e2e-cluster-config

# ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ²ÑĞµ e2e Job'Ñ‹
kubectl get jobs -n e2e-tests

# ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Pod'Ñ‹
kubectl get pods -n e2e-tests

# ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Job'Ğ°
kubectl logs -n e2e-tests -l job-name=e2e-test-sds-node-configurator-1234567890
```

### ĞÑ‚Ğ»Ğ°Ğ´ĞºĞ° Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸

```bash
# Ğ¡Ğ»ĞµĞ´Ğ¸Ñ‚ÑŒ Ğ·Ğ° Ğ»Ğ¾Ğ³Ğ°Ğ¼Ğ¸ Pod'Ğ°
kubectl logs -n e2e-tests -l app=e2e-tests -f

# ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğº Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ğ¾Ğ¼Ñƒ Pod'Ñƒ
POD_NAME=$(kubectl get pods -n e2e-tests -l app=e2e-tests -o jsonpath='{.items[0].metadata.name}')
kubectl exec -it -n e2e-tests $POD_NAME -- /bin/bash
```

### Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Job'Ğ°

```bash
# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Job Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚
cat <<EOF > e2e-test-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: e2e-test-manual
  namespace: e2e-tests
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: e2e-tests
        image: golang:1.22
        command:
        - /bin/bash
        - -c
        - |
          set -e
          git clone https://github.com/deckhouse/sds-e2e.git /workspace/sds-e2e
          cd /workspace/sds-e2e/testkit_v2
          go mod download
          go test -v -timeout 60m ./tests/*sds*_test.go -stand local -verbose -debug
        resources:
          requests:
            memory: "4Gi"
            cpu: "2"
          limits:
            memory: "8Gi"
            cpu: "4"
EOF

# ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ
kubectl apply -f e2e-test-job.yaml

# Ğ¡Ğ»ĞµĞ´Ğ¸Ñ‚ÑŒ Ğ·Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸ĞµĞ¼
kubectl logs -n e2e-tests -l job-name=e2e-test-manual -f
```

## âš™ï¸ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Job'Ğ°

### Ğ ĞµÑÑƒÑ€ÑÑ‹

```yaml
resources:
  requests:
    memory: "4Gi"   # ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²
    cpu: "2"        # 2 CPU cores
  limits:
    memory: "8Gi"   # ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼
    cpu: "4"        # 4 CPU cores
```

ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ‚Ğ¸Ğ¿Ğ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²:
- **Smoke**: 2Gi RAM, 1 CPU
- **Integration**: 4Gi RAM, 2 CPU
- **Full**: 8Gi RAM, 4 CPU

### Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚

```yaml
spec:
  activeDeadlineSeconds: 5400  # 90 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼
```

### TTL Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ

```yaml
spec:
  ttlSecondsAfterFinished: 86400  # Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· 24 Ñ‡Ğ°ÑĞ°
```

## ğŸ¯ ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ° ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ°

1. **Ğ˜Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ**: Ğ¢ĞµÑÑ‚Ñ‹ Ğ½Ğµ Ğ²Ğ»Ğ¸ÑÑÑ‚ Ğ½Ğ° GitHub runners
2. **Ğ ĞµÑÑƒÑ€ÑÑ‹**: E2E ĞºĞ»Ğ°ÑÑ‚ĞµÑ€ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ² (CPU, RAM, storage)
3. **Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ**: Ğ¡ĞµĞºÑ€ĞµÑ‚Ñ‹ Ğ¾ÑÑ‚Ğ°ÑÑ‚ÑÑ Ğ² ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğµ
4. **ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ**: ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾
5. **ĞÑ‚Ğ»Ğ°Ğ´ĞºĞ°**: Ğ›ĞµĞ³ĞºĞ¾ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğº Pod'Ñƒ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
6. **Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ**: Ğ’ÑĞµ Ğ»Ğ¾Ğ³Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ñ‡ĞµÑ€ĞµĞ· kubectl
7. **ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³**: Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ Kubernetes Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ¾Ğ¼

## ğŸ› Troubleshooting

### Job Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº e2e ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ñƒ

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ kubeconfig
echo "$E2E_CLUSTER_KUBECONFIG" | base64 -d | kubectl --kubeconfig=- cluster-info

# ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞµĞºÑ€ĞµÑ‚
cat ~/.kube/e2e-cluster-config | base64 -w 0 | gh secret set E2E_CLUSTER_KUBECONFIG
```

### Job Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ² ÑÑ‚Ğ°Ñ‚ÑƒÑĞµ Pending

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ² Ğ² ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğµ

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ€ĞµÑÑƒÑ€ÑÑ‹ Ğ½Ğ¾Ğ´
kubectl top nodes

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Pod'Ğ°
kubectl describe pod -n e2e-tests <pod-name>

# Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞ¸Ñ‚ÑŒ Ñ€ĞµÑÑƒÑ€ÑÑ‹ Ğ² Job Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğµ
```

### Ğ¢ĞµÑÑ‚Ñ‹ Ğ¿Ğ°Ğ´Ğ°ÑÑ‚ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¾Ğ¹ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ kubeconfig Ğ´Ğ»Ñ hypervisor

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ secret
kubectl get secret e2e-kubeconfigs -n e2e-tests -o yaml

# ĞŸĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ secret
kubectl delete secret e2e-kubeconfigs -n e2e-tests
kubectl create secret generic e2e-kubeconfigs \
  --from-file=hypervisor=~/.kube/hypervisor-config \
  --namespace=e2e-tests
```

### Ğ›Ğ¾Ğ³Ğ¸ Ğ½Ğµ Ğ¿Ğ¾ÑĞ²Ğ»ÑÑÑ‚ÑÑ Ğ² PR

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ÑˆĞ°Ğ³Ğµ "Comment PR with results"

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ workflow
gh run view --log

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ° GitHub token
# Token Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¸Ğ¼ĞµÑ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ½Ğ° `write:issues`
```

## ğŸ“š Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹

- [ADR-002: E2E Tests Integration via Labels](ADR-002-E2E-Tests-Integration-via-Labels.md)
- [Quick Start: E2E Labels](QUICK-START-E2E-Labels.md)
- [Integration Into Build Pipeline](E2E-Integration-Into-Build.md)

