# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è E2E —Ç–µ—Å—Ç–æ–≤ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Build Pipeline

## üìã –û–±–∑–æ—Ä

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é e2e —Ç–µ—Å—Ç–æ–≤ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `build.yml` workflow –º–æ–¥—É–ª–µ–π Deckhouse.

## üéØ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏**: E2E —Ç–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è job'—ã `dev_setup_build`
2. **–£—Å–ª–æ–≤–Ω—ã–π –∑–∞–ø—É—Å–∫**: –¢–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ª–µ–π–±–ª–∞ `e2e-test` –≤ PR

## üîß –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### 1. Job `parse_e2e_labels`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–∞—Ä—Å–∏–Ω–≥ –ª–µ–π–±–ª–æ–≤ PR –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—É—Å–∫–∞ e2e —Ç–µ—Å—Ç–æ–≤.

**–£—Å–ª–æ–≤–∏–µ –∑–∞–ø—É—Å–∫–∞:**
```yaml
if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
```

**Outputs:**
- `run-e2e`: `true` –µ—Å–ª–∏ –µ—Å—Ç—å –ª–µ–π–±–ª `e2e-test`, –∏–Ω–∞—á–µ `false`
- `test-type`: —Ç–∏–ø —Ç–µ—Å—Ç–æ–≤ (`smoke`, `full`, `integration`)
- `environment`: –æ–∫—Ä—É–∂–µ–Ω–∏–µ (`local`, `bare-metal`, `hypervisor`)

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ª–µ–π–±–ª—ã:**
- `e2e-test` - **–æ—Å–Ω–æ–≤–Ω–æ–π –ª–µ–π–±–ª** –¥–ª—è –∑–∞–ø—É—Å–∫–∞ e2e —Ç–µ—Å—Ç–æ–≤
- `e2e:smoke` - –∑–∞–ø—É—Å–∫ smoke —Ç–µ—Å—Ç–æ–≤
- `e2e:full` - –∑–∞–ø—É—Å–∫ –ø–æ–ª–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
- `e2e:hypervisor` - –∑–∞–ø—É—Å–∫ –Ω–∞ hypervisor –æ–∫—Ä—É–∂–µ–Ω–∏–∏
- `e2e:bare-metal` - –∑–∞–ø—É—Å–∫ –Ω–∞ bare-metal –æ–∫—Ä—É–∂–µ–Ω–∏–∏

### 2. Job `run_e2e_tests`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–ø—É—Å–∫ e2e —Ç–µ—Å—Ç–æ–≤.

**–£—Å–ª–æ–≤–∏–µ –∑–∞–ø—É—Å–∫–∞:**
```yaml
if: ${{ needs.parse_e2e_labels.outputs.run-e2e == 'true' }}
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
```yaml
needs:
  - dev_setup_build  # –ñ–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
  - parse_e2e_labels # –ñ–¥–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ –ª–µ–π–±–ª–æ–≤
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ö–ª–æ–Ω–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π `deckhouse/sds-e2e`
2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ (kubeconfig, SSH –∫–ª—é—á–∏)
3. –ó–∞–ø—É—Å–∫–∞–µ—Ç e2e —Ç–µ—Å—Ç—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–µ–π–±–ª–æ–≤
4. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
5. –ü—É–±–ª–∏–∫—É–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤ PR
6. –û—á–∏—â–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

## üì¶ –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ–∫—Ä–µ—Ç—ã

–î–æ–±–∞–≤—å—Ç–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –º–æ–¥—É–ª—è —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã:

```bash
# GitHub CLI
gh secret set E2E_TRIGGER_TOKEN           # Token –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ sds-e2e
gh secret set KUBECONFIG_HYPERVISOR       # Base64-encoded kubeconfig (hypervisor)
gh secret set KUBECONFIG_BARE_METAL       # Base64-encoded kubeconfig (bare-metal)
gh secret set SSH_PRIVATE_KEY             # SSH –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–æ–¥–∞–º
gh secret set SSH_HOST                    # SSH —Ö–æ—Å—Ç (user@hostname)
gh secret set DECKHOUSE_LICENSE           # –õ–∏—Ü–µ–Ω–∑–∏—è Deckhouse
```

### –ö–∞–∫ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å kubeconfig –≤ base64:

```bash
# Linux/macOS
cat ~/.kube/config | base64 -w 0

# –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ GitHub:
cat ~/.kube/config | base64 -w 0 | gh secret set KUBECONFIG_HYPERVISOR
```

## üè∑Ô∏è –õ–µ–π–±–ª—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –ª–µ–π–±–ª–æ–≤ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

```bash
# –û—Å–Ω–æ–≤–Ω–æ–π –ª–µ–π–±–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞
gh label create "e2e-test" \
  --description "Run E2E tests" \
  --color "0E8A16"

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ª–µ–π–±–ª—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ)
gh label create "e2e:smoke" \
  --description "Run smoke tests" \
  --color "FBCA04"

gh label create "e2e:full" \
  --description "Run full tests" \
  --color "1D76DB"

gh label create "e2e:hypervisor" \
  --description "Run on hypervisor" \
  --color "C5DEF5"

gh label create "e2e:bare-metal" \
  --description "Run on bare-metal" \
  --color "5319E7"
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫ e2e —Ç–µ—Å—Ç–æ–≤

1. –°–æ–∑–¥–∞–π—Ç–µ PR
2. –î–æ–±–∞–≤—å—Ç–µ –ª–µ–π–±–ª `e2e-test`
3. CI –∑–∞–ø—É—Å—Ç–∏—Ç e2e —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏

```bash
# –ß–µ—Ä–µ–∑ GitHub CLI
gh pr edit <PR_NUMBER> --add-label "e2e-test"

# –ò–ª–∏ —á–µ—Ä–µ–∑ UI GitHub
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Smoke —Ç–µ—Å—Ç—ã (–±—ã—Å—Ç—Ä—ã–µ)

```bash
gh pr edit <PR_NUMBER> --add-label "e2e-test" --add-label "e2e:smoke"
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è:** 5-10 –º–∏–Ω—É—Ç (local –æ–∫—Ä—É–∂–µ–Ω–∏–µ)

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞ hypervisor

```bash
gh pr edit <PR_NUMBER> --add-label "e2e-test" --add-label "e2e:full" --add-label "e2e:hypervisor"
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è:** 30-60 –º–∏–Ω—É—Ç (hypervisor –æ–∫—Ä—É–∂–µ–Ω–∏–µ)

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ë–µ–∑ e2e —Ç–µ—Å—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

–ï—Å–ª–∏ –ª–µ–π–±–ª `e2e-test` –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω, CI —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ:
1. ‚úÖ `lint`
2. ‚úÖ `set_edition`
3. ‚úÖ `dev_setup_build`
4. ‚úÖ `analyze_build` (–µ—Å–ª–∏ –µ—Å—Ç—å –ª–µ–π–±–ª `analyze/svace`)
5. ‚è≠Ô∏è E2E —Ç–µ—Å—Ç—ã –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤

### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤ –≤ PR –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:

```markdown
## E2E Tests Results ‚úÖ

**Module:** sds-node-configurator
**Environment:** hypervisor
**Test Type:** integration
**Build:** pr123

E2E tests passed!

<details>
<summary>View Details</summary>

- **Workflow:** Build and push for dev
- **Run ID:** 1234567890
- **Commit:** abc123...
- **Triggered by:** `e2e-test` label

</details>
```

### –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã workflow:
- –ò–º—è: `e2e-test-results-<MODULE_NAME>-<environment>-<test-type>`
- –ü—É—Ç—å: `sds-e2e/testkit_v2/test-results/`
- –•—Ä–∞–Ω–µ–Ω–∏–µ: 7 –¥–Ω–µ–π

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–µ–π–±–ª–æ–≤

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ª–µ–π–±–ª—ã PR
gh pr view <PR_NUMBER> --json labels --jq '.labels[].name'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ e2e-test
gh pr view <PR_NUMBER> --json labels --jq '.labels[].name' | grep e2e-test
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫ workflow
gh run view --log

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è job
gh run view --log --job run_e2e_tests
```

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 1. –¢–µ—Å—Ç—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ª–µ–π–±–ª `e2e-test`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
gh pr edit <PR_NUMBER> --add-label "e2e-test"
```

#### 2. –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ sds-e2e

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π `E2E_TRIGGER_TOKEN`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
gh auth token | gh secret set E2E_TRIGGER_TOKEN
```

#### 3. –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π kubeconfig

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å kubeconfig
echo "$KUBECONFIG_HYPERVISOR" | base64 -d | kubectl --kubeconfig=- get nodes

# –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç
cat ~/.kube/config-hypervisor | base64 -w 0 | gh secret set KUBECONFIG_HYPERVISOR
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

1. **–ß–∞—Å—Ç–æ—Ç–∞ –∑–∞–ø—É—Å–∫–æ–≤**: —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å e2e —Ç–µ—Å—Ç—ã
2. **–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏**: —Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
3. **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–Ω–∏–º–∞–µ—Ç –∫–∞–∂–¥—ã–π —Ç–∏–ø —Ç–µ—Å—Ç–æ–≤
4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏–π**: –∫–∞–∫–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —á–∞—â–µ

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—É—Å–∫–æ–≤

```bash
# –í—Å–µ –∑–∞–ø—É—Å–∫–∏ workflow
gh run list --workflow "build.yml"

# –¢–æ–ª—å–∫–æ —Å e2e —Ç–µ—Å—Ç–∞–º–∏ (—Ñ–∏–ª—å—Ç—Ä –ø–æ –∏–º–µ–Ω–∏ job)
gh run list --workflow "build.yml" --json conclusion,name,status,databaseId | \
  jq '.[] | select(.name | contains("E2E"))'
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤—Å–µ –º–æ–¥—É–ª–∏**:
   - sds-node-configurator ‚úÖ
   - sds-replicated-volume
   - sds-local-volume
   - data-export

2. **–î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ª–µ–π–±–ª–æ–≤**:
   - `e2e:test:<test-name>` - –∑–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
   - `e2e:k8s:<version>` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏—è—Ö K8s
   - `e2e:migration` - –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

3. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º**:
   - –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫ –≤ Prometheus
   - Dashboards –≤ Grafana
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Slack

4. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å**:
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
   - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
   - –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏–π

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [ADR-002: E2E Tests Integration via Labels](ADR-002-E2E-Tests-Integration-via-Labels.md)
- [PoC: E2E Labels](POC-E2E-Labels.md)
- [Module Integration Guide](Module-Integration-Guide.md)

